<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<!-- namespace: 해당 mapper파일의 고유한 별칭 -->
 <mapper namespace="sellerMapper">
 
	<resultMap type="SellerInfo" id="sellerInfoResult">
		<result column="BUSINESS_NO" property="businessNo"/>
		<result column="USER_NO" property="userNo"/>
		<result column="BUSINESS_NAME" property="businessName"/>
		<result column="SUB_BUSINESS_NAME" property="subBusinessName"/>
		<result column="OPEN_BUSINESS_DATE" property="openBusinessDate"/>
		<result column="STORE_NAME" property="storeName"/>
		<result column="CRN" property="crn"/>
		<result column="MAIN_BUSINESS_NAME" property="mainBusinessName"/>
		<result column="MAIN_ITEM_NAME" property="mainItemName"/>
		<result column="BUSINESS_ADDRESS" property="businessAddress"/>
		<result column="BUSINESS_ACCOUNT" property="businessAccount"/>
		<result column="STATUS" property="status"/>	
	</resultMap>
	
 	<resultMap type="SellerPage" id="sellerPageResult">
 		<result column="SELLER_PAGE_NO" property="sellerPageNo"/>
		<result column="BUSINESS_NO" property="businessNo"/>
		<result column="SELLER_EXPLAIN" property="sellerExplain"/>
		<result column="SP_ENROLL_DATE" property="spEnrollDate"/>
		<result column="SP_ORIGIN_NAME" property="spOriginName"/>
		<result column="SP_CHANGE_NAME" property="spChangeName"/>
	</resultMap>

	<resultMap type="ProductCategory" id="productCategoryResult">
		<result column="C_NO" property="caNo"/>
		<result column="P_CATEGORY" property="pdCategory"/>
		<result column="SELLER_PAGE_NO" property="sellerPageNo"/>
	</resultMap>
	
	<resultMap type="Product" id="productResult">
		<result column="P_NO" property="pdNo"/>
		<result column="C_NO" property="caNo"/>
		<result column="P_CATEGORY" property="pdCategory"/>
		<result column="P_TITLE" property="pdTitle"/>
		<result column="P_PRICE" property="pdPrice"/>
		<result column="P_CONTENT" property="pdContent"/>
		<result column="P_ENROLL_DATE" property="pdEnrollDate"/>
		<result column="P_STAR" property="pdStar"/>
		<result column="P_ORIGIN_NAME" property="pdOriginName"/>
		<result column="P_CHANGE_NAME" property="pdChangeName"/>	
		<result column="P_STATUS" property="pdStatus"/>	
	</resultMap> 
	
	<resultMap type="ProductOption" id="productOptionResult">
		<result column="P_COUNT" property="pdCount"/>
		<result column="PO_STATUS" property="poStatus"/>	
		<result column="P_NO" property="pdNo"/>
		<result column="P_OPTION_NAME" property="optionName"/>
		<result column="P_OPTION_NO" property="pdOptionNo"/>
	</resultMap> 
	
	<resultMap type="Review" id="ReviewResult">
		<result column="REPLY_NO" property="replyNo"/>
		<result column="USER_NO" property="userNo"/>
		<result column="P_NO" property="pdNo"/>
		<result column="REVIEW_DATE" property="reviewDate"/>
		<result column="REVIEW_DIBS" property="reviewDibs"/>
		<result column="REVIEW_CONTENTS" property="reviewContents"/>
	</resultMap> 
	
	<resultMap type="StoreMainDTO" id="StoreMainDTOResult">
		<result column="SELLER_PAGE_NO" property="sellerPageNo"/>
		<result column="BUSINESS_NO" property="businessNo"/>
		<result column="P_CATEGORY" property="prCategory"/>
		<result column="STORE_NAME" property="storeName"/>
		<result column="P_NO" property="prNo"/>
		<result column="P_TITLE" property="prTitle"/>
		<result column="P_PRICE" property="prPrice"/>
		<result column="P_ENROLLDATE" property="prEnrollDate"/>
		<result column="P_STAR" property="prStar"/>
		<result column="P_CHANGE_NAME" property="prChangeName"/>
		<result column="P_STATUS" property="prStatus"/>
		<result column="USER_NO" property="userNo"/>
		<result column="REPLY_NO" property="replyNo"/>
		<result column="REVIEW_COUNT" property="reviewCount"/>
	</resultMap>
	
	<resultMap type="ProductDTO" id="ProductDTOResult">
		<result column="USER_NO" property="userNo"/>
		<result column="EMAIL" property="email"/>
		<result column="PHONE" property="phone"/>
		<result column="BUSINESS_NO" property="businessNo"/>
		<result column="BUSINESS_NAME" property="businessName"/>
		<result column="STORE_NAME" property="storeName"/>
		<result column="MAIN_BUSINESS_NAME" property="mainBusinessName"/>
		<result column="BUSINESS_ADDRESS" property="businessAddress"/>
		<result column="SELLER_PAGE_NO" property="sellerPageNo"/>
		<result column="C_NO" property="caNo"/>
		<result column="CATEGORY" property="category"/>
		<result column="P_NO" property="pdNo"/>
		<result column="C_NO" property="caNo"/>
		<result column="P_CATEGORY" property="pdCategory"/>
		<result column="P_TITLE" property="pdTitle"/>
		<result column="P_PRICE" property="pdPrice"/>
		<result column="P_CONTENT" property="pdContent"/>
		<result column="P_ENROLL_DATE" property="pdEnrollDate"/>
		<result column="P_STAR" property="pdStar"/>
		<result column="P_ORIGIN_NAME" property="pdOriginName"/>
		<result column="P_CHANGE_NAME" property="pdChangeName"/>	
		<result column="P_STATUS" property="pdStatus"/>	
		<result column="P_COUNT" property="pdCount"/>
		<result column="PO_STATUS" property="poStatus"/>	
		<result column="P_OPTION_NAME" property="optionName"/>
		<result column="P_OPTION_NO" property="pdOptionNo"/>
		<result column="REPLY_NO" property="pdOptionNo"/>
		<result column="REVIEW_DATE" property="reviewDate"/>
		<result column="REVIEW_DIBS" property="reviewDibs"/>
		<result column="REVIEW_CONTENTS" property="reviewContents"/>
		<result column="REVIEW_COUNT" property="reviewCount"/>
	</resultMap>
	
	<select id="selectSeller" resultMap="sellerInfoResult">
		SELECT *
		  FROM SELLER_INFO
		 WHERE USER_NO = #{userNo}
		   AND STATUS = 'Y'
	</select>
	
	<select id="getBusinessNo" resultType="_int">
		SELECT BUSINESS_NO
		FROM SELLER_INFO
		WHERE USER_NO = #{userNo}
	</select>
	
	<select id="getSellerPageNo" resultType="_int">
	 	SELECT seller_page_no
          FROM SELLER_PAGE
         WHERE BUSINESS_NO = #{businessNo}
	</select>
	
	<insert id="insertSellerHome">
		INSERT INTO
					SELLER_PAGE (
								 business_no,
								 seller_explain,
								 sp_enroll_Date,
								 sp_origin_name,
								 sp_change_name
								 
								 )
						 VALUES (
						 		 #{businessNo},
								 #{sellerExplain},
								 default,
								 #{spOriginName},
								 #{spChangeName}
								 							 		 
						 		 )	 
	</insert>
	
	<insert id="insertProductCategory">
		INSERT INTO 
					PRODUCT_CATEGORY (
								 	  p_category,
								 	  seller_page_no
								 	  )
						 	  VALUES (
							 		  #{category}, 
							 		  CURRVAL('seller_page_seller_page_no_seq'::regclass)
						 		 	  )	
	</insert>

	<select id="selectCategories" resultMap="productCategoryResult">
		SELECT P_CATEGORY,
			   C_NO	
		  FROM PRODUCT_CATEGORY
		  JOIN SELLER_PAGE USING (SELLER_PAGE_NO)
		WHERE BUSINESS_NO = #{businessNo}
	</select>
	
	<select id="selectSellerHomeDetail" resultMap="sellerPageResult">
		SELECT SELLER_PAGE_NO,
			   SELLER_EXPLAIN,
			   SP_ORIGIN_NAME,
			   SP_CHANGE_NAME
		  FROM SELLER_PAGE
		 WHERE BUSINESS_NO = #{businessNo}
	</select>
	
	<update id="updateSellerHome">
		UPDATE SELLER_PAGE
		   SET SELLER_EXPLAIN = #{sellerExplain},
		   	   SP_ENROLL_DATE = CURRENT_TIMESTAMP,
		   	   SP_ORIGIN_NAME = #{spOriginName},
		   	   SP_CHANGE_NAME = #{spChangeName}
		 WHERE BUSINESS_NO = #{businessNo}   			
	</update>
	
	<insert id="insertNewProductCategory">
		INSERT INTO 
					PRODUCT_CATEGORY (
								 	  p_category,
								 	  seller_page_no
								 	  )
						 	  VALUES (
							 		  #{pdCategory}, 
							 		  #{sellerPageNo}
						 		 	  )	
	</insert> 
	
 	<delete id="deleteProductCategory">
		DELETE FROM PRODUCT_CATEGORY
		 WHERE C_NO = #{caNo} 
	</delete>
	
	<select id="countByBusinessNo" resultType="int">
        SELECT COUNT(*)
        FROM SELLER_PAGE
        WHERE BUSINESS_NO = #{businessNo}
    </select>
	
	<insert id="insertProduct">
	INSERT INTO 
				PRODUCT (
				 	      c_no,
				 	      p_title,
				 	      p_price,
				 	      p_content,
				 	      p_enroll_date,
				 	      p_star,
				 	      p_origin_name,
				 	      p_change_name,
				 	      p_status
				 	     )
		 	     VALUES (
			 		      #{caNo},
			 		      #{pdTitle},
			 		      #{pdPrice},
			 		      #{pdContent},
			 		      default,
			 		      default,
			 		      #{pdOriginName},
			 		      #{pdChangeName},
			 		      default
		 		 	     )	
	</insert>
	
	<insert id="insertProductOption">
		INSERT INTO 
					PRODUCT_OPTION (
									  p_count,
								 	  po_status,
								 	  p_no,
								 	  p_option_name
								 	  )
						 	  VALUES (
							 		  #{pdCount},
							 		  default,
							 		  CURRVAL('product_p_no_seq'::regclass),
							 		 #{optionName}
						 		 	  )	
	</insert>
	
	<!-- 게시글의 총 갯수 조회 -->
	<select id="selectProductListCount" resultType="_int">
		SELECT COUNT(*)
		  FROM PRODUCT
		 WHERE P_STATUS = 'Y'
	</select>
	
	<select id="selectProductList" resultMap="productResult">
		SELECT P_NO,
			   C_NO,
			   P_CATEGORY,
			   P_TITLE,
			   TO_CHAR(P_ENROLL_DATE , 'YYYY-MM-DD') AS "P_ENROLL_DATE"
		  FROM PRODUCT
		  JOIN PRODUCT_CATEGORY USING(C_NO)
		  JOIN SELLER_PAGE USING(SELLER_PAGE_NO)
		 WHERE P_STATUS = 'Y'
		   AND BUSINESS_NO = #{businessNo}
		 ORDER BY P_NO DESC; 
	</select>
	
	<select id="selectProduct" resultMap="productResult">
		SELECT *
		  FROM PRODUCT
		  JOIN PRODUCT_CATEGORY USING(C_NO)
		 WHERE P_STATUS = 'Y'
		   AND P_NO = #{pno}
	</select>
	
	<!-- 상품 정보 수정  -->
	<update id="updateProduct">
	    UPDATE PRODUCT
	    SET 
	        P_TITLE = #{pdTitle},
	        <if test="pdOriginName != null">
	            P_ORIGIN_NAME = #{pdOriginName},
	            P_CHANGE_NAME = #{pdChangeName},
	        </if>
	        P_CONTENT = #{pdContent}
	    WHERE P_NO = #{pno}
	</update>

	
	<insert id="insertNewProductOption">
		INSERT INTO 
					PRODUCT_OPTION (
									  p_count,
								 	  po_status,
								 	  p_no,
								 	  p_option_name
								 	  )
						 	  VALUES (
							 		  #{pdCount},
							 		  default,
							 		  #{pno},
							 		 #{optionName}
						 		 	  )	
	</insert>
	
	<update id="updateProductOption">
	    UPDATE PRODUCT_OPTION
	    <set>
	        <if test="pdCount != null">
	            P_COUNT = #{pdCount},
	        </if>
	        <if test="optionName != null">
	            P_OPTION_NAME = #{optionName},
	        </if>
	    </set>
	    WHERE P_OPTION_NO = #{pdOptionNo}
	</update>

	
	<delete id="deleteProductOption">
		DELETE FROM PRODUCT_OPTION
		 WHERE P_OPTION_NO = #{pdOptionNo} 
	</delete>
	
	<update id="deleteProduct">
		UPDATE PRODUCT
		   SET P_STATUS = 'N' 
		 WHERE P_NO = #{pno} 
	</update>
	
	<select id="selectOptions" resultMap="productOptionResult">
		SELECT P_COUNT,
			   P_OPTION_NAME,
			   P_OPTION_NO	
		  FROM PRODUCT_OPTION
		WHERE P_NO = #{pno}
	</select>
	
	<select id="selectPopularList" resultMap="StoreMainDTOResult">
	SELECT *
	  FROM (
		    SELECT P_NO ,STORE_NAME,SELLER_PAGE_NO, P_TITLE, P_PRICE, P_CHANGE_NAME, P_STAR, COUNT(REVIEW.REPLY_NO) AS REVIEW_COUNT
		    FROM PRODUCT
		    JOIN PRODUCT_CATEGORY USING(C_NO)
		    JOIN SELLER_PAGE USING(SELLER_PAGE_NO)
		    JOIN SELLER_INFO USING(BUSINESS_NO)
		    LEFT JOIN REVIEW USING(P_NO)
		    WHERE P_STATUS = 'Y'
		    GROUP BY P_NO, SELLER_PAGE_NO, STORE_NAME, P_TITLE, P_PRICE, P_STAR
		    ORDER BY P_STAR DESC
		    )
	 LIMIT 10;
	</select>
	
	<select id="selectRecentList" resultMap="StoreMainDTOResult">
		SELECT *
		  FROM (
		        SELECT P_NO, STORE_NAME,SELLER_PAGE_NO, P_TITLE, P_PRICE, P_CHANGE_NAME, P_STAR, COUNT(REVIEW.REPLY_NO) AS REVIEW_COUNT
		        FROM PRODUCT
			    JOIN PRODUCT_CATEGORY USING(C_NO)
			    JOIN SELLER_PAGE USING(SELLER_PAGE_NO)
			    JOIN SELLER_INFO USING(BUSINESS_NO)
			    LEFT JOIN REVIEW USING(P_NO)
			    WHERE P_STATUS = 'Y'
			    GROUP BY P_NO, SELLER_PAGE_NO, STORE_NAME, P_TITLE, P_PRICE, P_STAR
			    ORDER BY P_ENROLL_DATE DESC
			    )
		 LIMIT 10;
	</select>
	
	<select id="selectSalesProduct" resultMap="ProductDTOResult">
		SELECT EMAIL, PHONE, BUSINESS_NO,BUSINESS_NAME, STORE_NAME, SELLER_PAGE_NO,
			   MAIN_BUSINESS_NAME,BUSINESS_ADDRESS, P_NO, P_TITLE, 
			   P_PRICE, P_CONTENT, P_STAR, P_CHANGE_NAME, 
		       COUNT(REVIEW.REPLY_NO) AS REVIEW_COUNT
		  FROM MEMBER
		  JOIN SELLER_INFO USING(USER_NO)
		  JOIN SELLER_PAGE USING(BUSINESS_NO)
		  JOIN PRODUCT_CATEGORY USING(SELLER_PAGE_NO)
		  JOIN PRODUCT USING(C_NO)
		  LEFT JOIN REVIEW USING(P_NO)
		 WHERE P_STATUS = 'Y' AND P_NO = 55
		 GROUP BY EMAIL, PHONE, BUSINESS_NO,BUSINESS_NAME, STORE_NAME, SELLER_PAGE_NO,
				MAIN_BUSINESS_NAME,BUSINESS_ADDRESS, P_NO, P_TITLE, 
				P_PRICE, P_CONTENT, P_STAR, P_CHANGE_NAME ;
	</select>
	
	<select id="selectAllProduct" resultMap="StoreMainDTOResult">
		SELECT P_NO, STORE_NAME,SELLER_PAGE_NO, P_TITLE, P_PRICE, P_CHANGE_NAME, P_STAR, COUNT(REVIEW.REPLY_NO) AS REVIEW_COUNT
		  FROM PRODUCT
		  JOIN PRODUCT_CATEGORY USING(C_NO)
		  JOIN SELLER_PAGE USING(SELLER_PAGE_NO)
		  JOIN SELLER_INFO USING(BUSINESS_NO)
		  LEFT JOIN REVIEW USING(P_NO)
		 WHERE P_STATUS = 'Y'
		 GROUP BY P_NO, SELLER_PAGE_NO, STORE_NAME, P_TITLE, P_PRICE, P_STAR
		 ORDER BY P_ENROLL_DATE DESC
	</select>
	
	<select id="getAlarmList" resultMap="StoreMainDTOResult">
		SELECT store_name,
			   SELLER_PAGE_NO
		FROM seller_info
		JOIN seller_page using(business_no)
		WHERE seller_page_no in (SELECT seller_page_no
								FROM public.user_alarm
								WHERE user_no = #{userNo}
								AND alarm = 1)
	</select>
	 
</mapper>